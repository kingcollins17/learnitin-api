============================= test session starts ==============================
platform darwin -- Python 3.13.3, pytest-9.0.2, pluggy-1.6.0 -- /Library/Frameworks/Python.framework/Versions/3.13/bin/python3
cachedir: .pytest_cache
rootdir: /Users/zidepeople/Development/learnitin-api
configfile: pytest.ini
plugins: anyio-4.12.0, Faker-40.1.0, asyncio-1.3.0, langsmith-0.6.0, cov-7.0.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collecting ... collected 3 items

tests/verify_start_lesson.py::test_start_lesson_new ERROR                [ 33%]
tests/verify_start_lesson.py::test_start_lesson_existing_locked ERROR    [ 66%]
tests/verify_start_lesson.py::test_start_lesson_existing_unlocked ERROR  [100%]

==================================== ERRORS ====================================
___________________ ERROR at setup of test_start_lesson_new ____________________
file /Users/zidepeople/Development/learnitin-api/tests/verify_start_lesson.py, line 9
  @pytest.mark.asyncio
  async def test_start_lesson_new(mocker):
      # Mock mocks
      session = AsyncMock()
      mock_user_lesson_repo = AsyncMock()
      mock_lesson_repo = AsyncMock()
      mock_user_module_repo = AsyncMock()
      mock_user_module_service = AsyncMock()
      mock_user_course_repo = AsyncMock()

      mocker.patch(
          "app.features.lessons.service.UserLessonRepository",
          return_value=mock_user_lesson_repo,
      )
      mocker.patch(
          "app.features.lessons.service.LessonRepository", return_value=mock_lesson_repo
      )
      mocker.patch(
          "app.features.lessons.service.UserModuleRepository",
          return_value=mock_user_module_repo,
      )
      mocker.patch(
          "app.features.lessons.service.UserModuleService",
          return_value=mock_user_module_service,
      )
      mocker.patch(
          "app.features.lessons.service.UserCourseRepository",
          return_value=mock_user_course_repo,
      )

      service = UserLessonService(session)

      # Setup mocks
      mock_user_lesson_repo.get_by_user_and_lesson.return_value = None
      mock_user_module_repo.get_by_user_and_module.return_value = (
          MagicMock()
      )  # Module exists
      mock_lesson_repo.get_by_id.return_value = MagicMock(order=1)
      mock_lesson_repo.get_previous_lesson.return_value = None  # No previous lesson

      mock_user_lesson_repo.create.return_value = UserLesson(
          user_id=1,
          lesson_id=10,
          module_id=2,
          course_id=3,
          status=ProgressStatus.IN_PROGRESS,
          is_lesson_unlocked=True,
      )

      result = await service.start_lesson(
          user_id=1, lesson_id=10, module_id=2, course_id=3
      )

      assert result.is_lesson_unlocked == True
      mock_user_lesson_repo.create.assert_called_once()
E       fixture 'mocker' not found
>       available fixtures: _class_scoped_runner, _function_scoped_runner, _module_scoped_runner, _package_scoped_runner, _session_faker, _session_scoped_runner, anyio_backend, anyio_backend_name, anyio_backend_options, auth_headers, auth_token, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, capteesys, client, cov, created_user, db_session, doctest_namespace, event_loop, event_loop_policy, faker, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, monkeypatch, no_cover, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, subtests, test_engine, test_user_data, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/Users/zidepeople/Development/learnitin-api/tests/verify_start_lesson.py:9
_____________ ERROR at setup of test_start_lesson_existing_locked ______________
file /Users/zidepeople/Development/learnitin-api/tests/verify_start_lesson.py, line 66
  @pytest.mark.asyncio
  async def test_start_lesson_existing_locked(mocker):
      session = AsyncMock()
      mock_user_lesson_repo = AsyncMock()
      mocker.patch(
          "app.features.lessons.service.UserLessonRepository",
          return_value=mock_user_lesson_repo,
      )
      # Patch other repos to avoid errors in init
      mocker.patch(
          "app.features.lessons.service.LessonRepository", return_value=AsyncMock()
      )
      mocker.patch(
          "app.features.lessons.service.UserModuleRepository", return_value=AsyncMock()
      )
      mocker.patch(
          "app.features.lessons.service.UserModuleService", return_value=AsyncMock()
      )
      mocker.patch(
          "app.features.lessons.service.UserCourseRepository", return_value=AsyncMock()
      )

      service = UserLessonService(session)

      existing_lesson = UserLesson(
          user_id=1,
          lesson_id=10,
          module_id=2,
          course_id=3,
          status=ProgressStatus.IN_PROGRESS,
          is_lesson_unlocked=False,
      )
      mock_user_lesson_repo.get_by_user_and_lesson.return_value = existing_lesson

      result = await service.start_lesson(
          user_id=1, lesson_id=10, module_id=2, course_id=3
      )

      assert result.is_lesson_unlocked == True
      mock_user_lesson_repo.update.assert_called_once()
E       fixture 'mocker' not found
>       available fixtures: _class_scoped_runner, _function_scoped_runner, _module_scoped_runner, _package_scoped_runner, _session_faker, _session_scoped_runner, anyio_backend, anyio_backend_name, anyio_backend_options, auth_headers, auth_token, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, capteesys, client, cov, created_user, db_session, doctest_namespace, event_loop, event_loop_policy, faker, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, monkeypatch, no_cover, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, subtests, test_engine, test_user_data, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/Users/zidepeople/Development/learnitin-api/tests/verify_start_lesson.py:66
____________ ERROR at setup of test_start_lesson_existing_unlocked _____________
file /Users/zidepeople/Development/learnitin-api/tests/verify_start_lesson.py, line 108
  @pytest.mark.asyncio
  async def test_start_lesson_existing_unlocked(mocker):
      session = AsyncMock()
      mock_user_lesson_repo = AsyncMock()
      mocker.patch(
          "app.features.lessons.service.UserLessonRepository",
          return_value=mock_user_lesson_repo,
      )
      # Patch other repos to avoid errors in init
      mocker.patch(
          "app.features.lessons.service.LessonRepository", return_value=AsyncMock()
      )
      mocker.patch(
          "app.features.lessons.service.UserModuleRepository", return_value=AsyncMock()
      )
      mocker.patch(
          "app.features.lessons.service.UserModuleService", return_value=AsyncMock()
      )
      mocker.patch(
          "app.features.lessons.service.UserCourseRepository", return_value=AsyncMock()
      )

      service = UserLessonService(session)

      existing_lesson = UserLesson(
          user_id=1,
          lesson_id=10,
          module_id=2,
          course_id=3,
          status=ProgressStatus.IN_PROGRESS,
          is_lesson_unlocked=True,
      )
      mock_user_lesson_repo.get_by_user_and_lesson.return_value = existing_lesson

      result = await service.start_lesson(
          user_id=1, lesson_id=10, module_id=2, course_id=3
      )

      assert result.is_lesson_unlocked == True
      mock_user_lesson_repo.update.assert_not_called()
E       fixture 'mocker' not found
>       available fixtures: _class_scoped_runner, _function_scoped_runner, _module_scoped_runner, _package_scoped_runner, _session_faker, _session_scoped_runner, anyio_backend, anyio_backend_name, anyio_backend_options, auth_headers, auth_token, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, capteesys, client, cov, created_user, db_session, doctest_namespace, event_loop, event_loop_policy, faker, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, monkeypatch, no_cover, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, subtests, test_engine, test_user_data, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/Users/zidepeople/Development/learnitin-api/tests/verify_start_lesson.py:108
=============================== warnings summary ===============================
app/common/responses.py:9
  /Users/zidepeople/Development/learnitin-api/app/common/responses.py:9: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ApiResponse(BaseModel, Generic[T]):

../../../../Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages/sqlmodel/main.py:534
../../../../Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages/sqlmodel/main.py:534
../../../../Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages/sqlmodel/main.py:534
../../../../Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages/sqlmodel/main.py:534
../../../../Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages/sqlmodel/main.py:534
../../../../Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages/sqlmodel/main.py:534
../../../../Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages/sqlmodel/main.py:534
  /Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages/sqlmodel/main.py:534: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    new_cls = super().__new__(cls, name, bases, dict_used, **config_kwargs)

app/features/users/schemas.py:31
  /Users/zidepeople/Development/learnitin-api/app/features/users/schemas.py:31: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class UserResponse(UserBase):

app/features/courses/schemas.py:60
  /Users/zidepeople/Development/learnitin-api/app/features/courses/schemas.py:60: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class CourseGenerationResponse(BaseModel):

app/features/courses/schemas.py:91
  /Users/zidepeople/Development/learnitin-api/app/features/courses/schemas.py:91: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class CategoryResponse(CategoryBase):

app/features/courses/schemas.py:123
  /Users/zidepeople/Development/learnitin-api/app/features/courses/schemas.py:123: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class SubCategoryResponse(SubCategoryBase):

app/features/courses/schemas.py:164
  /Users/zidepeople/Development/learnitin-api/app/features/courses/schemas.py:164: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class CourseResponse(CourseBase):

app/features/courses/schemas.py:182
  /Users/zidepeople/Development/learnitin-api/app/features/courses/schemas.py:182: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class LessonResponse(BaseModel):

app/features/courses/schemas.py:195
  /Users/zidepeople/Development/learnitin-api/app/features/courses/schemas.py:195: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ModuleResponse(BaseModel):

app/features/courses/schemas.py:215
  /Users/zidepeople/Development/learnitin-api/app/features/courses/schemas.py:215: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class UserCourseResponse(BaseModel):

app/features/courses/schemas.py:231
  /Users/zidepeople/Development/learnitin-api/app/features/courses/schemas.py:231: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PaginatedCoursesResponse(BaseModel):

app/features/courses/schemas.py:243
  /Users/zidepeople/Development/learnitin-api/app/features/courses/schemas.py:243: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PaginatedUserCoursesResponse(BaseModel):

app/features/modules/schemas.py:35
  /Users/zidepeople/Development/learnitin-api/app/features/modules/schemas.py:35: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ModuleResponse(ModuleBase):

app/features/modules/schemas.py:79
  /Users/zidepeople/Development/learnitin-api/app/features/modules/schemas.py:79: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class UserModuleResponse(BaseModel):

app/features/lessons/schemas.py:41
  /Users/zidepeople/Development/learnitin-api/app/features/lessons/schemas.py:41: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class LessonResponse(LessonBase):

app/features/lessons/schemas.py:132
  /Users/zidepeople/Development/learnitin-api/app/features/lessons/schemas.py:132: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class UserLessonResponse(BaseModel):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform darwin, python 3.13.3-final-0 _______________

Name                                         Stmts   Miss Branch BrPart  Cover   Missing
----------------------------------------------------------------------------------------
app/__init__.py                                  0      0      0      0   100%
app/common/__init__.py                           0      0      0      0   100%
app/common/config.py                            32      0      0      0   100%
app/common/database/__init__.py                  0      0      0      0   100%
app/common/database/base.py                      2      2      0      0     0%   2-6
app/common/database/session.py                  25     16      0      0    36%   37-45, 50-62, 67
app/common/deps.py                              34     22      8      0    29%   21-48, 66-68
app/common/email.py                             23      9      4      1    56%   19, 52-60
app/common/responses.py                         13      2      0      0    85%   58, 89
app/common/security.py                          24     14      2      0    38%   33, 46, 51-59, 64-68
app/core/__init__.py                             0      0      0      0   100%
app/core/config.py                              20     20      0      0     0%   1-33
app/core/deps.py                                23     23      8      0     0%   1-41
app/core/security.py                            24     24      2      0     0%   1-35
app/cron/__init__.py                             0      0      0      0   100%
app/db/__init__.py                               0      0      0      0   100%
app/db/init_db.py                                7      7      2      0     0%   1-10
app/db/session.py                               12     12      0      0     0%   1-21
app/features/__init__.py                         0      0      0      0   100%
app/features/auth/__init__.py                    0      0      0      0   100%
app/features/auth/otp_models.py                 12      0      0      0   100%
app/features/auth/otp_repository.py             48     34     10      0    24%   13, 20-33, 40-48, 52-55, 61-77, 81-85, 89-91
app/features/auth/otp_schemas.py                12      0      0      0   100%
app/features/auth/otp_service.py                48     36     16      0    19%   14, 20-69, 75-88, 92, 116-138
app/features/auth/router.py                     60     38      2      0    35%   20-21, 54-65, 108-119, 136-146, 162-178
app/features/auth/schemas.py                    13      0      0      0   100%
app/features/auth/service.py                    21      8      2      0    57%   18, 22, 47-64
app/features/courses/__init__.py                 0      0      0      0   100%
app/features/courses/generation_service.py      19     12      4      0    30%   35-89
app/features/courses/models.py                  71      0      0      0   100%
app/features/courses/repository.py             146    104     10      0    27%   13, 17-20, 24-32, 38-41, 45-48, 52-55, 59-60, 64-65, 78-100, 107, 111-114, 120-125, 131-137, 143-152, 156-163, 169-177, 181-184, 188-191, 195-196, 203, 207-210, 214-219, 223-228, 232-235, 239-242, 246-247, 254, 258-263, 267-272, 278-286, 290-295, 299-302, 306-309, 313-314
app/features/courses/router.py                 204    157      2      0    23%   56-69, 87-95, 120-141, 161-178, 195-207, 231-258, 281-297, 326-353, 374-392, 412-424, 441-451, 469-484, 501-513, 533-545, 563-575, 595-610, 627-639
app/features/courses/schemas.py                131      0      0      0   100%
app/features/courses/service.py                155    116     52      0    19%   39-43, 57-119, 136-156, 160-163, 190-191, 211, 227-228, 248-260, 279-304, 317-332, 339-340, 345-355, 361-362, 368-380, 384-391, 398-400, 405-425, 431-436, 442-468, 472-479
app/features/lessons/__init__.py                 0      0      0      0   100%
app/features/lessons/generation_service.py      14      4      0      0    71%   31-65
app/features/lessons/lecture_service.py          9      3      0      0    67%   40-51
app/features/lessons/models.py                  40      0      0      0   100%
app/features/lessons/repository.py              65     40      0      0    38%   15, 19-22, 28-35, 41-48, 54-61, 65-68, 72-75, 79-80, 84-90, 97, 101-104, 110-115, 121-126, 132-137, 141-144, 148-151, 155-156
app/features/lessons/router.py                 237    192     28      0    17%   67-101, 117-135, 152-162, 180-195, 212-224, 244-286, 301-326, 347-386, 403-419, 437-461, 478-494, 504-549, 566-613, 632-648, 665-681
app/features/lessons/schemas.py                 96     15      6      0    79%   56-69, 74-81
app/features/lessons/service.py                136    102     44      0    19%   20-24, 36-52, 65, 80-85, 89, 105-106, 124-125, 139, 151-152, 168-184, 196-204, 211-216, 237-307, 322, 337, 355-363, 382-398, 411, 428, 445, 463-487
app/features/modules/__init__.py                 0      0      0      0   100%
app/features/modules/models.py                  34      0      0      0   100%
app/features/modules/repository.py              62     38      0      0    39%   15, 19-22, 28-35, 41-48, 52-57, 61-64, 68-71, 75-76, 80-86, 93, 97-100, 106-111, 117-122, 126-129, 133-136, 140-141
app/features/modules/router.py                 127     96      2      0    24%   46-67, 83-101, 118-128, 146-161, 178-190, 210-227, 244-269, 286-302, 320-344, 361-377
app/features/modules/schemas.py                 53      0      0      0   100%
app/features/modules/service.py                 79     57     26      0    21%   17-18, 34-35, 49, 61-62, 78-94, 106-114, 121-124, 144-197, 212, 230-238, 257-273, 286
app/features/users/__init__.py                   0      0      0      0   100%
app/features/users/models.py                    18      0      0      0   100%
app/features/users/repository.py                32     19      0      0    41%   12, 16-19, 23-26, 30-33, 37-40, 44-47, 51-52, 57-60
app/features/users/router.py                    82     59      2      0    27%   28-38, 51-60, 74-90, 112-127, 164-199
app/features/users/schemas.py                   27      0      0      0   100%
app/features/users/service.py                   61     45     26      0    18%   17, 22-43, 47-52, 56-88, 92, 96-101, 105-119
app/main.py                                     28      5      0      0    82%   17-20, 59, 69
app/services/__init__.py                         2      0      0      0   100%
app/services/audio_generation_service.py        77     59     24      1    19%   22, 34, 39-126, 130-156, 160-187
app/services/email_service.py                   36     22     12      1    31%   18, 43-81
app/services/image_generation_service.py        30     17     10      1    35%   19, 31, 36-85
app/services/langchain_service.py               40     19     14      2    43%   54, 62-73, 110-137, 161-163
app/services/storage_service.py                 45     20     12      4    51%   24->exit, 26->42, 30, 37-38, 47-55, 74-89, 108-115
----------------------------------------------------------------------------------------
TOTAL                                         2609   1468    330     10    39%
Coverage HTML written to dir htmlcov
=========================== short test summary info ============================
ERROR tests/verify_start_lesson.py::test_start_lesson_new
ERROR tests/verify_start_lesson.py::test_start_lesson_existing_locked
ERROR tests/verify_start_lesson.py::test_start_lesson_existing_unlocked
======================== 22 warnings, 3 errors in 1.09s ========================
